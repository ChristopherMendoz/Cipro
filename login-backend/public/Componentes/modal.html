<!-- Modal Login -->
<div id="modalLogin" class="modal">
  <div class="modal-content animate-in login-size">
    <span class="close" onclick="cerrarModalLogin()">&times;</span>
    <form id="loginForm" class="login-form form-panel">
      <img src="../logo.jpg" alt="Logo" class="modal-logo" />
      <h2>Iniciar Sesi√≥n</h2>
      <input type="text" name="username" placeholder="Usuario" required />
      <input type="password" name="contrasena" placeholder="Contrase√±a" required />
      <a href="#" onclick="mostrarModalRecuperar(event)" class="forgot-password-link">¬øOlvid√© mi contrase√±a?</a>
      <button type="submit">Entrar</button>
      <p id="mensajeError" class="error-msg"></p>
      <p class="registro">¬øNo tienes cuenta? <a href="#" onclick="abrirRegistro(event)">Reg√≠strate aqu√≠</a></p>
    </form>
  </div>
</div>

<!-- Modal Registro -->
<div id="modalRegistro" class="modal">
  <div class="modal-content animate-in registro-size">
    <span class="close" onclick="cerrarModalRegistro()">&times;</span>
    <form id="registroForm" class="login-form form-panel">
      <img src="../logo.jpg" alt="Logo" class="modal-logo" />
      <h2>Registro de Usuario</h2>
      <input type="text" name="primerNombre" placeholder="Primer Nombre" required />
      <input type="text" name="segundoNombre" placeholder="Segundo Nombre" required />
      <input type="text" name="primerApellido" placeholder="Primer Apellido" required />
      <input type="text" name="segundoApellido" placeholder="Segundo Apellido" required />
      <label for="fechaNacimiento">Fecha de Nacimiento</label>
      <input type="date" name="fechaNacimiento" required>
      <label for="sexo">G√©nero</label>
      <select name="sexo" required>
        <option value="">Seleccione</option>
        <option value="masculino">Masculino</option>
        <option value="femenino">Femenino</option>
      </select>
      <input type="text" name="direccion" placeholder="Direcci√≥n" required>
      <input type="text" name="telefono" placeholder="Tel√©fono" required>
      <label for="tipoSangre">Tipo de Sangre</label>
      <select name="tipoSangre" id="tipoSangre" required>
        <option value="">-- Seleccione su tipo --</option>
        <option value="A+">A+</option>
        <option value="A-">A-</option>
        <option value="B+">B+</option>
        <option value="B-">B-</option>
        <option value="AB+">AB+</option>
        <option value="AB-">AB-</option>
        <option value="O+">O+</option>
        <option value="O-">O-</option>
      </select>
      <input type="email" name="correo" placeholder="Correo Electr√≥nico" required />
      <input type="text" name="nombreUsuario" placeholder="Nombre de Usuario" required />
      <div class="password-container">
        <input type="password" name="contrase√±a" id="password" placeholder="Contrase√±a" required />
        <span class="toggle-password" onclick="togglePassword()">üëÅÔ∏è</span>
      </div>
      <div class="form-group-checkbox">
        <input type="checkbox" id="aceptoTerminos" name="aceptoTerminos">
        <label for="aceptoTerminos">
          Acepto los <a href="#" onclick="mostrarTerminos('terminos', event)">T√©rminos y condiciones</a> y declaro
          conocer la <a href="#" onclick="mostrarTerminos('privacidad', event)">Protecci√≥n de Privacidad</a>.
        </label>
      </div>
      <div class="form-group-checkbox">
        <input type="checkbox" id="aceptoPromociones" name="aceptoPromociones">
        <label for="aceptoPromociones">
          Doy mi consentimiento para <a href="#" onclick="mostrarTerminos('adicionales', event)">usos adicionales</a>,
          como disfrutar de beneficios y promociones.
        </label>
      </div>
      <button type="submit">Registrar</button>
      <p id="mensajeErrorRegistro" class="error-msg"></p>
      <p class="registro">¬øYa tienes cuenta? <a href="#" onclick="abrirLogin(event)">Iniciar sesi√≥n</a></p>
    </form>
  </div>
</div>

<div id="modalTerminos" class="modal">
  <div class="modal-content-terminos">
    <span class="close-terminos" onclick="cerrarTerminos()">&times;</span>
    <h2 id="terminosTitulo"></h2>
    <div id="terminosContenido" class="terminos-scroll-content"></div>
    <button onclick="cerrarTerminos()" class="btn-terminos">CONFIRMAR</button>
  </div>
</div>

<div id="modalRecuperar" class="modal">
  <div class="modal-content animate-in login-size">
    <span class="close" onclick="cerrarModalRecuperar()">&times;</span>
    <form id="recuperarForm" class="login-form form-panel">
      <img src="../logo.jpg" alt="Logo" class="modal-logo" />
      <h2>Recuperar Contrase√±a</h2>
      <p class="modal-instructions">Ingresa tu correo electr√≥nico y te enviaremos un enlace para restablecer tu
        contrase√±a.</p>
      <input type="email" name="correoRecuperar" placeholder="Tu correo electr√≥nico" required />
      <button type="submit">Enviar Enlace</button>
      <p id="mensajeRecuperar" class="error-msg"></p>
    </form>
  </div>
</div>

<script>

  // Objeto con los textos legales para mostrar en el modal
  const textosLegales = {
    terminos: {
      titulo: "T√©rminos y Condiciones de Registro",
      contenido: `En Cl√≠nica Cipro nos preocupamos por la protecci√≥n y privacidad de los datos personales de nuestros usuarios. Por ello, garantizamos la absoluta confidencialidad de los mismos y empleamos altos est√°ndares de seguridad conforme a lo establecido en la <strong>Ley N¬∞ 787, Ley de Protecci√≥n de los Datos Personales de Nicaragua</strong>, y su normativa de desarrollo.`
    },
    privacidad: {
      titulo: "Pol√≠tica de Protecci√≥n de Privacidad",
      contenido: `Su privacidad es importante. La informaci√≥n personal recopilada ser√° utilizada para gestionar su registro, agendar citas y comunicarnos con usted sobre sus servicios. No compartiremos sus datos con terceros sin su consentimiento expl√≠cito, salvo obligaci√≥n legal.`
    },
    adicionales: {
      titulo: "Consentimiento para Usos Adicionales",
      contenido: `Al marcar esta opci√≥n, usted autoriza a Cl√≠nica Cipro a utilizar su informaci√≥n de contacto (correo electr√≥nico y tel√©fono) para enviarle informaci√≥n sobre nuevos servicios, beneficios, promociones y descuentos especiales. Puede revocar este consentimiento en cualquier momento.`
    }
  };
  function abrirModal() {
    const modal = document.getElementById('modalLogin');
    const modalContent = modal.querySelector('.modal-content');
    modal.style.display = 'flex';
    modalContent.classList.remove('animate-in', 'registro-size');
    void modalContent.offsetWidth;
    modalContent.classList.add('animate-in', 'login-size');
    // document.getElementById("formSlider").style.transform = "translateX(0)"; // <-- Elimina o comenta esta l√≠nea
  }

  function cerrarModal() {
    document.getElementById("modalLogin").style.display = "none";
  }

  function abrirLogin(event) {
    if (event) event.preventDefault();
    document.getElementById('modalRegistro').style.display = 'none';
    document.getElementById('modalLogin').style.display = 'flex';
  }
  function abrirRegistro(event) {
    if (event) event.preventDefault();
    document.getElementById('modalLogin').style.display = 'none';
    document.getElementById('modalRegistro').style.display = 'flex';
  }
  function cerrarModalLogin() {
    document.getElementById('modalLogin').style.display = 'none';
    document.getElementById('loginForm').reset();
    const mensaje = document.getElementById('mensajeError');
    mensaje.textContent = "";
    mensaje.classList.remove("visible");
  }
  function cerrarModalRegistro() {
    document.getElementById('modalRegistro').style.display = 'none';
    document.getElementById('registroForm').reset();
    const mensaje = document.getElementById('mensajeErrorRegistro');
    mensaje.textContent = "";
    mensaje.classList.remove("visible");
  }

  function mostrarTerminos(tipo, event) {
    event.preventDefault(); // Evita que el link '#' recargue la p√°gina
    const modal = document.getElementById('modalTerminos');
    const tituloEl = document.getElementById('terminosTitulo');
    const contenidoEl = document.getElementById('terminosContenido');

    if (textosLegales[tipo]) {
      tituloEl.textContent = textosLegales[tipo].titulo;
      contenidoEl.innerHTML = `<p>${textosLegales[tipo].contenido}</p>`;
      modal.style.display = 'flex';
    }
  }

  function cerrarTerminos() {
    document.getElementById('modalTerminos').style.display = 'none';
  }

  // Cerrar modal al hacer click fuera del contenido
  window.onclick = function (e) {
    if (e.target === document.getElementById("modalLogin")) cerrarModalLogin();
    if (e.target === document.getElementById("modalRegistro")) cerrarModalRegistro();
    if (e.target === document.getElementById("modalTerminos")) cerrarTerminos();

  };

  document.getElementById("loginForm").addEventListener("submit", async function (event) {
    event.preventDefault();
    const username = event.target.username.value;
    const contrasena = event.target.contrasena.value;
    const mensaje = document.getElementById("mensajeError");

    try {
      const res = await fetch("/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ Username: username, Contrasena: contrasena })
      });

      const data = await res.json();

      if (data.ok) {
        // ‚úÖ Guarda el idUsuario en sessionStorage para usarlo despu√©s
        sessionStorage.setItem("idUsuario", data.idUsuario); // üëà ESTA L√çNEA ES CLAVE
        window.location.href = data.redireccion;
      } else {
        mensaje.textContent = data.mensaje;
        mensaje.classList.add("visible"); // En lugar de style.display
        setTimeout(() => mensaje.classList.remove("visible"), 4000);
      }
    } catch (err) {
      mensaje.textContent = "Error del servidor.";
      mensaje.classList.add("visible");
      setTimeout(() => mensaje.classList.remove("visible"), 4000);
    }
  });

  // Slide entre login y registro
  function mostrarRegistro(e) {
    e.preventDefault();
    document.getElementById("formSlider").style.transform = "translateX(-50%)";
    const modal = document.querySelector('.modal-content');
    modal.classList.remove('login-size');
    modal.classList.add('registro-size');
  }


  function mostrarLogin(e) {
    e.preventDefault();
    document.getElementById("formSlider").style.transform = "translateX(0)";
    const modal = document.querySelector('.modal-content');
    modal.classList.remove('registro-size');
    modal.classList.add('login-size');
  }

  // Mostrar/ocultar contrase√±a en registro
  function togglePassword() {
    const input = document.getElementById("password");
    input.type = input.type === "password" ? "text" : "password";
  }

  // Registro AJAX
  document.getElementById("registroForm").addEventListener("submit", async function (event) {
    event.preventDefault();


    const form = event.target;
    const datos = {
      primerNombre: form.primerNombre.value.trim(),
      segundoNombre: form.segundoNombre.value.trim(),
      primerApellido: form.primerApellido.value.trim(),
      segundoApellido: form.segundoApellido.value.trim(),
      fechaNacimiento: form.fechaNacimiento.value,
      sexo: form.sexo.value,
      direccion: form.direccion.value.trim(),
      telefono: form.telefono.value.trim(),
      tipoSangre: form.tipoSangre.value.trim(),
      correo: form.correo.value.trim(),
      nombreUsuario: form.nombreUsuario.value.trim(),
      contrasena: form.contrase√±a.value.trim()
    };

    const mensaje = document.getElementById("mensajeErrorRegistro");
    const terminosCheckbox = document.getElementById('aceptoTerminos');
    const soloLetras = /^[a-zA-Z√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë\s]+$/;
    const passwordSegura = /^(?=.*[a-zA-Z])(?=.*\d).{5,}$/;


    if (!terminosCheckbox.checked) {
      mensaje.style.color = "#cc0000";
      mostrarMensaje("Debes aceptar los T√©rminos y Condiciones para continuar.");
      return; // Detiene el env√≠o del formulario
    }
    if (!soloLetras.test(datos.primerNombre)) {
      mensaje.style.color = "#cc0000";
      return mostrarMensaje("El nombre solo debe contener letras.");
    }
    if (!soloLetras.test(datos.primerApellido)) {
      mensaje.style.color = "#cc0000";
      return mostrarMensaje("El apellido solo debe contener letras.");
    }
    if (!passwordSegura.test(datos.contrasena)) {
      mensaje.style.color = "#cc0000";
      return mostrarMensaje("La contrase√±a debe tener al menos 5 caracteres y contener al menos un n√∫mero.");
    }

    try {
      const res = await fetch("/register", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(datos)
      });

      const data = await res.json();

      if (data.ok) {
        mensaje.style.color = "green";
        mostrarMensaje("‚úÖ Registro exitoso, redirigiendo...");
        setTimeout(() => {
          window.location.href = "/Clinica.html";
        }, 2000);
      } else {
        mensaje.style.color = "#cc0000";
        mostrarMensaje(data.mensaje || "Error al registrar.");
      }
    } catch (err) {
      mensaje.style.color = "#cc0000";
      mostrarMensaje("Error del servidor.");
    }

    function mostrarMensaje(texto) {
      mensaje.innerText = texto;
      mensaje.classList.add("visible");
      setTimeout(() => {
        mensaje.classList.remove("visible");
      }, 4000);
    }
  });

  // Funciones para el nuevo modal de recuperaci√≥n
  function mostrarModalRecuperar(event) {
    event.preventDefault();
    cerrarModalLogin(); // Cierra el modal de login
    document.getElementById('modalRecuperar').style.display = 'flex';
  }

  function cerrarModalRecuperar() {
    document.getElementById('modalRecuperar').style.display = 'none';
    document.getElementById('recuperarForm').reset();
    document.getElementById('mensajeRecuperar').textContent = '';
    document.getElementById('mensajeRecuperar').className = 'form-message';
  }

  // Listener para el formulario de recuperaci√≥n
  document.getElementById('recuperarForm').addEventListener('submit', async function (e) {
    e.preventDefault();
    const correo = e.target.correoRecuperar.value;
    const mensajeEl = document.getElementById('mensajeRecuperar');

    // Ocultamos cualquier mensaje previo
    mensajeEl.classList.remove('visible');
    // Revertimos el estilo en caso de que fuera de √©xito
    mensajeEl.style.backgroundColor = '';
    mensajeEl.style.color = '';

    mensajeEl.textContent = 'Enviando...';
    mensajeEl.style.color = '#17a2b8'; // Color informativo
    mensajeEl.classList.add('visible');

    try {
      const res = await fetch('/forgot-password', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ correo: correo })
      });
      const data = await res.json();

      if (res.ok) {
        mensajeEl.textContent = data.mensaje;
        // Aplicamos estilo de √©xito directamente
        mensajeEl.style.backgroundColor = '#d4edda';
        mensajeEl.style.borderColor = '#c3e6cb';
        mensajeEl.style.color = '#155724';
        mensajeEl.classList.add('visible');
      } else {
        mensajeEl.textContent = data.mensaje;
        // Dejamos que la clase .error-msg se encargue del estilo de error
        mensajeEl.classList.add('visible');
      }
    } catch (err) {
      mensajeEl.textContent = 'Error de conexi√≥n con el servidor.';
      // Dejamos que la clase .error-msg se encargue del estilo de error
      mensajeEl.classList.add('visible');
    }
  });

  // Aseg√∫rate de que el clic fuera del modal tambi√©n lo cierre
  window.onclick = function (e) {
    if (e.target === document.getElementById("modalLogin")) cerrarModalLogin();
    if (e.target === document.getElementById("modalRegistro")) cerrarModalRegistro();
    if (e.target === document.getElementById("modalTerminos")) cerrarTerminos();
    if (e.target === document.getElementById("modalRecuperar")) cerrarModalRecuperar(); // <-- A√±ade esta l√≠nea
  };

</script>