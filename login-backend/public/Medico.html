<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>M√©dico</title>
    <link rel="stylesheet" href="medicostyle.css" />
</head>

<body>
    <header>
        <button id="cerrarSesion">Cerrar sesi√≥n</button>
    </header>

    <div class="container">
        <aside class="sidebar">
            <h2 id="nombreUsuario">üë®‚Äç‚öïÔ∏è Cargando...</h2>
            <h3>Gesti√≥n M√©dico</h3>
            <a href="#" id="btnDatosPersonales">Datos Personales</a>
            <a href="#" id="btnAgenda">Agenda</a>
            <a href="#" id="btnDatosConsulta">Datos Consultas</a>
            <a href="#" id="btnResultados">Cargar Resultados</a>
        </aside>
        <section id="inicioPanelMedico" class="contenido">
            <img src="logosinfondo.png" alt="Logo de Cl√≠nica Cipro" class="logo-panel-inicio">
            <p>Bienvenido al Panel de M√©dico. Seleccione una opci√≥n del men√∫.</p>
        </section>
        <section class="contenido hidden" id="seccionDatosPersonalesMedico">
            <h2>Bienvenido</h2>
            <p>Seleccione una opci√≥n del men√∫ lateral para comenzar.</p>
        </section>

        <section id="seccionAgenda" class="contenido hidden">
            <h2>Agenda</h2>
            <p>Aqu√≠ ira la agenda.</p>
        </section>

        <section id="formConsulta" class="contenido hidden">
            <h2>Agregar Nueva Consulta</h2>
            <form id="formAgregarConsulta">
                <label>Fecha: <input type="date" name="fecha" required></label><br><br>
                <label>Hora: <input type="time" name="hora" required></label><br><br>
                <label>Estado:
                    <select name="estado" required>
                        <option value="pendiente">Pendiente</option>
                        <option value="realizada">Realizada</option>
                        <option value="cancelada">Cancelada</option>
                    </select>
                </label><br><br>
                    <select id="selectServicio" name="idServicio" required>
                        <option value="">Cargando‚Ä¶</option>
                    </select>
                </label><br><br>
                <label>Observaciones: <textarea name="observaciones"></textarea></label><br><br>
                <label>Paciente:
                    <select id="selectPaciente" name="idPaciente" required>
                        <option value="">Cargando‚Ä¶</option>
                    </select>
                </label><br><br>
                <label>M√©dico:
                    <select id="selectMedico" name="idMedico" required>
                        <option value="">Cargando‚Ä¶</option>
                    </select>
                </label><br><br>
                <label>Sala:
                    <select id="selectSala" name="idSala" required>
                        <option value="">Cargando‚Ä¶</option>
                    </select>
                </label><br><br>
                <label>Recepcionista:
                    <select id="selectRecepcionista" name="idRecepcionista" required>
                        <option value="">Cargando‚Ä¶</option>
                    </select>
                </label><br><br>
                <button type="submit">Agregar Consulta</button>
            </form>
            <div id="mensajeConsulta" style="margin-top:10px; color: green;"></div>
        </section>

        <section id="listaConsultas" class="contenido consultas-container hidden">
            <h2>Lista de Consultas</h2>
            <div class="filtros">
                <label for="filtroEstado">Filtrar por estado:</label>
                <select id="filtroEstado">
                    <option value="">Todos</option>
                    <option value="pendiente">Pendiente</option>
                    <option value="realizada">Realizada</option>
                    <option value="cancelada">Cancelada</option>
                </select>

                <!-- CORRECCI√ìN: El placeholder ahora coincide con el ID del input -->
                <label for="busquedaServicio">Buscar por servicio:</label>
                <input type="text" id="busquedaServicio" placeholder="Nombre del servicio...">
            </div>
            <table id="tablaConsultas" border="1" cellpadding="8" cellspacing="0">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Fecha</th>
                        <th>Hora</th>
                        <th>Estado</th>
                        <th>Paciente</th>
                        <th>M√©dico</th>
                        <th>Sala</th>
                        <th>Recepcionista</th>
                        <th>Observaciones</th>
                        <th>Tipo de Servicio</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Se llenar√° con JS -->
                </tbody>
            </table>
        </section>
        
        <!-- Secci√≥n de Cargar Resultados (no se ha tocado) -->
        <section id="seccionCargarResultados" class="contenido hidden">
            <h2>Cargar Resultados</h2>
            <p>Aqu√≠ ir√° el formulario para subir resultados.</p>
        </section>
    </div>

</body>

<!-- CORRECCI√ìN 1: Se ha combinado todo el JavaScript en un solo bloque <script> para evitar errores de funciones duplicadas -->
<script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- REFERENCIAS A ELEMENTOS (SIN CAMBIOS) ---
        const nombreUsuarioEl = document.getElementById("nombreUsuario");
        const inicioPanelMedicoEl = document.getElementById("inicioPanelMedico");
        const seccionDatosPersonalesMedicoEl = document.getElementById("seccionDatosPersonalesMedico");
        const seccionAgendaEl = document.getElementById("seccionAgenda");
        const formConsultaEl = document.getElementById("formConsulta");
        const listaConsultasEl = document.getElementById("listaConsultas");
        const seccionCargarResultadosEl = document.getElementById("seccionCargarResultados");
        const btnDatosPersonales = document.getElementById("btnDatosPersonales");
        const btnAgenda = document.getElementById("btnAgenda");
        const btnResultados = document.getElementById("btnResultados");
        const btnDatosConsulta = document.getElementById("btnDatosConsulta");

        document.getElementById("cerrarSesion").addEventListener("click", () => {
            sessionStorage.clear();
            localStorage.clear();
            window.location.href = "/Clinica.html";
        });

        // --- FUNCI√ìN PARA MOSTRAR SECCIONES (SIN CAMBIOS) ---
        function mostrarSeccion(seccionesIdsAMostrar) {
            if (!Array.isArray(seccionesIdsAMostrar)) {
                seccionesIdsAMostrar = [seccionesIdsAMostrar];
            }
            const todasLasSeccionesDeContenido = [
                inicioPanelMedicoEl, seccionDatosPersonalesMedicoEl, seccionAgendaEl,
                formConsultaEl, listaConsultasEl, seccionCargarResultadosEl
            ];
            todasLasSeccionesDeContenido.forEach(seccion => {
                if (seccion) {
                    seccion.classList.toggle('hidden', !seccionesIdsAMostrar.includes(seccion.id));
                }
            });
        }

        // CORRECCI√ìN 2: Se a√±ade `{ credentials: 'include' }` a CADA `fetch` para enviar la cookie de sesi√≥n.
        
        async function cargarNombreUsuarioYMostrarInicio() {
            try {
                const resNombre = await fetch('/nombre-usuario', { credentials: 'include' });
                if (resNombre.status === 401) {
                    window.location.href = '/Clinica.html';
                    return;
                }
                const dataNombre = await resNombre.json();
                if (dataNombre.ok) {
                    nombreUsuarioEl.textContent = `üë®‚Äç‚öïÔ∏è ${dataNombre.nombreUsuario}`;
                    mostrarSeccion('inicioPanelMedico');
                } else {
                    nombreUsuarioEl.textContent = "Usuario no encontrado";
                }
            } catch (err) {
                console.error("Error al verificar sesi√≥n o cargar nombre:", err);
                nombreUsuarioEl.textContent = "Error de conexi√≥n";
            }
        }
        
        async function cargarDatosPersonalesMedico() {
            mostrarSeccion("seccionDatosPersonalesMedico");
            const targetEl = document.getElementById("seccionDatosPersonalesMedico");
            targetEl.innerHTML = "<h2>Cargando Datos Personales...</h2>";
            try {
                const res = await fetch('/obtener-medico', { credentials: 'include' });
                if (res.status === 401) {
                    targetEl.innerHTML = "<p>No autorizado. Inicie sesi√≥n como m√©dico.</p>";
                    return;
                }
                const data = await res.json();
                if (data.ok) {
                    const info = data.datos;
                    targetEl.innerHTML = `
                        <h2>Datos Personales</h2>
                        <p><strong>Nombre Completo:</strong> ${info.nombreCompleto}</p>
                        <p><strong>C√©dula Profesional:</strong> ${info.cedulaProfesional}</p>
                        <p><strong>Tel√©fono:</strong> ${info.telefono}</p>
                        <p><strong>Especializaci√≥n:</strong> ${info.nombreEspecializacion}</p>
                        <p><strong>Nombre de Usuario:</strong> ${info.nombreUsuario}</p>`;
                } else {
                    targetEl.innerHTML = `<p>No se encontraron datos: ${data.mensaje || 'Error'}</p>`;
                }
            } catch (err) {
                console.error("Error al obtener datos personales:", err);
                targetEl.innerHTML = "<p>Error al obtener los datos personales.</p>";
            }
        }

        // --- C√ìDIGO DE MANEJO DE CONSULTAS (CON CORRECCIONES) ---

        let consultasGlobales = []; // Declarada una sola vez

        async function cargarConsultas() {
            try {
                const res = await fetch('/consultas', { credentials: 'include' });
                const data = await res.json();
                if (data.ok) {
                    consultasGlobales = data.consultas;
                    aplicarFiltros(); // Llama a la funci√≥n que renderiza la tabla
                } else {
                    alert('Error al cargar consultas: ' + (data.mensaje || 'Respuesta no v√°lida'));
                }
            } catch (err) {
                alert('Error de conexi√≥n al cargar consultas.');
                console.error(err);
            }
        }

        function aplicarFiltros() {
            const filtroEstado = document.querySelector('#filtroEstado').value.toLowerCase();
            const busquedaServicio = document.querySelector('#busquedaServicio').value.toLowerCase();
            const tbody = document.querySelector('#tablaConsultas tbody');
            tbody.innerHTML = '';
            
            if (!Array.isArray(consultasGlobales)) {
                console.error("consultasGlobales no es un array");
                return;
            }

            const filtradas = consultasGlobales.filter(c => {
                const estadoMatch = filtroEstado === '' || (c.estado?.toLowerCase() || '') === filtroEstado;
                const servicioMatch = c.nombreServicio?.toLowerCase().includes(busquedaServicio);
                return estadoMatch && servicioMatch;
            });
            
            if (filtradas.length === 0) {
                tbody.innerHTML = `<tr><td colspan="10" style="text-align: center;">No se encontraron consultas.</td></tr>`;
                return;
            }

            filtradas.forEach(c => {
                const fila = document.createElement('tr');
                const fechaFormateada = c.fecha ? c.fecha.split('T')[0] : 'Sin fecha';
                // CORRECCI√ìN 3: Se ha eliminado la columna duplicada de 'nombreServicio'
                fila.innerHTML = `
                    <td>${c.idConsulta || ''}</td>
                    <td>${fechaFormateada}</td>
                    <td>${c.hora || ''}</td>
                    <td>${c.estado || ''}</td>
                    <td>${c.nombrePaciente || ''}</td>
                    <td>${c.nombreMedico || ''}</td>
                    <td>${c.nombreSala || ''}</td>
                    <td>${c.nombreRecepcionista || ''}</td>
                    <td>${c.observaciones || ''}</td>
                    <td>${c.nombreServicio || ''}</td>`;
                tbody.appendChild(fila);
            });
        }
        
        document.querySelector('#filtroEstado').addEventListener('change', aplicarFiltros);
        document.querySelector('#busquedaServicio').addEventListener('input', aplicarFiltros);

        // --- C√ìDIGO DE FORMULARIO (CON CORRECCIONES) ---

        async function cargarCatalogos() {
            try {
                const [pacientesRes, medicosRes, salasRes, recepcionistasRes, serviciosRes] = await Promise.all([
                    fetch('/catalogos/pacientes', { credentials: 'include' }),
                    fetch('/catalogos/medicos', { credentials: 'include' }),
                    fetch('/catalogos/salas', { credentials: 'include' }),
                    fetch('/catalogos/recepcionistas', { credentials: 'include' }),
                    fetch('/catalogos/servicios', { credentials: 'include' })
                ]);
                
                // CORRECCI√ìN 4: Se ha eliminado el '1' suelto que causaba un error de sintaxis.
                
                llenarSelect(document.getElementById('selectPaciente'), await pacientesRes.json(), 'idPaciente', 'nombreCompleto');
                llenarSelect(document.getElementById('selectMedico'), await medicosRes.json(), 'idMedico', 'nombreCompleto');
                llenarSelect(document.getElementById('selectSala'), await salasRes.json(), 'idSala', 'nombre');
                llenarSelect(document.getElementById('selectRecepcionista'), await recepcionistasRes.json(), 'idRecepcionista', 'nombreCompleto');
                llenarSelect(document.getElementById('selectServicio'), await serviciosRes.json(), 'idServicio', 'nombreServicio');
                
            } catch (error) {
                console.error("Error al cargar los cat√°logos:", error);
            }
        }
        
        function llenarSelect(selectEl, datos, valueField, textField) {
             if (!selectEl) return;
             selectEl.innerHTML = '<option value="">Seleccione‚Ä¶</option>';
             if(Array.isArray(datos)) {
                datos.forEach(item => {
                    const opt = document.createElement('option');
                    opt.value = item[valueField];
                    opt.textContent = item[textField];
                    selectEl.appendChild(opt);
                });
             }
        }

        document.getElementById('formAgregarConsulta').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const datos = {
                fecha: form.fecha.value,
                hora: form.hora.value,
                estado: form.estado.value,
                observaciones: form.observaciones.value,
                idPaciente: parseInt(form.idPaciente.value),
                idMedico: parseInt(form.idMedico.value),
                idSala: parseInt(form.idSala.value),
                idRecepcionista: parseInt(form.idRecepcionista.value),
                idServicio: parseInt(form.idServicio.value)
            };

            const mensajeDiv = document.getElementById('mensajeConsulta');
            try {
                const res = await fetch('/agregar-consulta', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(datos),
                    credentials: 'include' // No olvidar las credenciales!
                });
                const data = await res.json();
                mensajeDiv.style.color = data.ok ? 'green' : 'red';
                mensajeDiv.textContent = data.mensaje;
                if (data.ok) {
                    form.reset();
                    cargarConsultas(); // refrescar tabla
                }
            } catch(err) {
                 mensajeDiv.style.color = 'red';
                 mensajeDiv.textContent = 'Error de conexi√≥n al agregar consulta.';
            }
        });
        
        // --- EVENT LISTENERS DE NAVEGACI√ìN (SIN CAMBIOS) ---
        btnDatosPersonales.addEventListener('click', (e) => {
            e.preventDefault();
            cargarDatosPersonalesMedico();
        });

        btnAgenda.addEventListener('click', (e) => {
            e.preventDefault();
            mostrarSeccion("seccionAgenda");
        });

        btnResultados.addEventListener('click', (e) => {
            e.preventDefault();
            mostrarSeccion("seccionCargarResultados");
        });

        btnDatosConsulta.addEventListener("click", (e) => {
            e.preventDefault();
            mostrarSeccion(["formConsulta", "listaConsultas"]);
            // No es necesario cargar las consultas de nuevo, ya se cargan al inicio
        });
        
        // --- INICIALIZACI√ìN DE LA P√ÅGINA ---
        cargarNombreUsuarioYMostrarInicio();
        cargarCatalogos();
        cargarConsultas();
    });
</script>

</html>
