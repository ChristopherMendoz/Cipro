<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>M√©dico</title>
    <link rel="stylesheet" href="medicostyle.css" />

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js" defer></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.14/index.global.min.js'></script>
</head>

<body>


    <div class="container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2 id="nombreUsuario">üë®‚Äç‚öïÔ∏è Cargando...</h2>
                <h3>Gesti√≥n M√©dico</h3>
            </div>
            <nav class="sidebar-nav">
                <ul>
                    <li><a href="#" id="btnDatosPersonales">Datos Personales</a></li>
                    <li><a href="#" id="btnAgenda">Agenda</a></li>
                    <li><a href="#" id="btnDatosConsulta">Datos Consultas</a></li>
                </ul>
            </nav>
            <div class="sidebar-footer">
                <button id="cerrarSesion">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path
                            d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z" />
                    </svg>
                    <span>Cerrar Sesi√≥n</span>
                </button>
            </div>
        </aside>
        <main class="main-content">
            <section id="inicioPanelMedico" class="contenido">
                <img src="logosinfondo.png" alt="Logo de Cl√≠nica Cipro" class="logo-panel-inicio">
                <p>Bienvenido al Panel de M√©dico. Seleccione una opci√≥n del men√∫.</p>
            </section>
            <section class="contenido hidden" id="seccionDatosPersonalesMedico">
                <h2>Bienvenido</h2>
                <p>Seleccione una opci√≥n del men√∫ lateral para comenzar.</p>
            </section>

            <section id="seccionAgenda" class="contenido hidden">
                <h2>Agenda</h2>
                <div class="agenda-layout">
                    <div class="calendario-container">
                        <div id="calendario-agenda"></div>
                    </div>

                    <div id="panelDetallesCita" class="panel-detalles">
                        <button id="cerrarPanelDetalles" class="cerrar-panel-btn">&times;</button>
                        <h3>Detalles de la Cita</h3>
                        <div class="detalles-contenido">
                            <div class="detalle-item">
                                <label>Servicio:</label>
                                <span id="detalleServicio">--</span>
                            </div>
                            <div class="detalle-item">
                                <label>Paciente:</label>
                                <span id="detallePaciente">--</span>
                            </div>
                            <div class="detalle-item">
                                <label>Fecha y Hora:</label>
                                <span id="detalleFechaHora">--</span>
                            </div>
                        </div>
                    </div>

                </div>
            </section>

            <section id="seccionDatosConsulta" class="contenido hidden">

                <div id="contenedorFormularioConsulta">
                    <h2>Agregar Nueva Consulta</h2>
                    <form id="formAgregarConsulta">
                        <div class="form-group">
                            <label for="fecha">Fecha:</label>
                            <input type="date" id="fecha" name="fecha" required>
                        </div>
                        <div class="form-group">
                            <label for="hora">Hora:</label>
                            <input type="time" id="hora" name="hora" required>
                        </div>
                        <div class="form-group full-width">
                            <label for="selectServicio">Tipo de Servicio:</label>
                            <select id="selectServicio" name="idServicio" required>
                                <option value="">Cargando‚Ä¶</option>
                            </select>
                        </div>
                        <div class="form-group full-width">
                            <label for="selectPaciente">Paciente (puede escribir para buscar):</label>
                            <select id="selectPaciente" name="idPaciente" required>
                                <option value="">Cargando‚Ä¶</option>
                            </select>
                        </div>

                        <div class="form-group full-width">
                            <label for="nombreMedicoLogueado">M√©dico:</label>
                            <input type="text" id="nombreMedicoLogueado" disabled value="Cargando...">
                            <input type="hidden" id="idMedicoLogueado" name="idMedico">
                        </div>

                        <div class="form-group full-width">
                            <label for="selectRecepcionista">Recepcionista:</label>
                            <select id="selectRecepcionista" name="idRecepcionista" required>
                                <option value="">Cargando‚Ä¶</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="selectSala">Sala:</label>
                            <select id="selectSala" name="idSala" required>
                                <option value="">Cargando‚Ä¶</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="estado">Estado:</label>
                            <select id="estado" name="estado" required>
                                <option value="pendiente">Pendiente</option>
                                <option value="realizada">Realizada</option>
                                <option value="cancelada">Cancelada</option>
                            </select>
                        </div>
                        <div class="form-group full-width">
                            <label for="observaciones">Observaciones:</label>
                            <textarea id="observaciones" name="observaciones"></textarea>
                        </div>
                        <p id="mensajeConsulta" class="mensaje-formulario"></p>
                        <div class="form-group full-width">
                            <button type="submit">Agregar Consulta</button>
                        </div>
                    </form>
                </div>

                <div id="contenedorListaConsultas">
                    <h2>Lista de Consultas</h2>
                    <div class="filtros">
                        <label for="filtroEstado">Filtrar por estado:</label>
                        <select id="filtroEstado">
                            <option value="">Todos</option>
                            <option value="pendiente">Pendiente</option>
                            <option value="realizada">Realizada</option>
                            <option value="cancelada">Cancelada</option>
                        </select>
                        <label for="busquedaGeneral">Buscar:</label>
                        <input type="text" id="busquedaGeneral" placeholder="Nombre de paciente">
                    </div>
                    <table id="tablaConsultas" border="1" cellpadding="8" cellspacing="0">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Fecha</th>
                                <th>Hora</th>
                                <th>Estado</th>
                                <th>Paciente</th>
                                <th>C√©dula</th>
                                <th>M√©dico</th>
                                <th>Sala</th>
                                <th>Recepcionista</th>
                                <th>Observaciones</th>
                                <th>Tipo de Servicio</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                    ...
                    </table>

                    <div class="pagination-controls">
                        <select id="rowsPerPage">
                            <option value="5">5</option>
                            <option value="10">10</option>
                            <option value="25">25</option>
                        </select>
                        <span>filas por p√°gina</span>
                        <div class="page-nav">
                            <button id="prevPage" disabled>&lt; Anterior</button>
                            <span id="pageInfo">P√°gina 1 de 1</span>
                            <button id="nextPage" disabled>Siguiente &gt;</button>
                        </div>
                    </div>
                </div>
    </div>

    </section>
    </main>

    </div>

    <div id="modalSubirImagenes" class="modal hidden">
        <div class="modal-content">
            <span class="close" id="closeModalSubida">&times;</span>
            <h2 id="modalSubidaTitulo">Gestionar Im√°genes</h2>
            <div id="galeriaImagenesExistentes" class="galeria-container">
            </div>

            <form id="formSubirImagenes">
                <input type="hidden" id="idConsultaParaSubida">

                <label for="inputArchivos">A√±adir nuevas im√°genes (m√°x. 10):</label>
                <input type="file" id="inputArchivos" name="imagenesConsulta" multiple accept="image/jpeg, image/png">

                <div id="previewsContainer" class="previews-container"></div>

                <label for="inputDescripcion">Descripci√≥n (opcional):</label>
                <textarea id="inputDescripcion" name="descripcion"
                    placeholder="Ej: Radiograf√≠a frontal de t√≥rax"></textarea>

                <button type="submit" disabled>Subir Nuevos Archivos</button>
                <p id="mensajeSubida" class="mensaje-formulario"></p>
            </form>
        </div>
    </div>

</body>

<!-- CORRECCI√ìN 1: Se ha combinado todo el JavaScript en un solo bloque <script> para evitar errores de funciones duplicadas -->
<script>

    document.addEventListener('DOMContentLoaded', () => {

        // =======================================================
        // == PARTE 1: DEFINICI√ìN DE TODAS LAS VARIABLES ==
        // =======================================================

        let consultasGlobales = [];
        let archivosParaSubir = [];
        let choicesPaciente = null; // <-- NUEVA VARIABLE
        let choicesMedico = null;   // <-- NUEVA VARIABLE

        let filteredConsultas = [];
        let currentPage = 1;
        let rowsPerPage = 5;

        // --- Referencias a elementos del panel ---
        const nombreUsuarioEl = document.getElementById("nombreUsuario");
        const inicioPanelMedicoEl = document.getElementById("inicioPanelMedico");
        const seccionDatosPersonalesMedicoEl = document.getElementById("seccionDatosPersonalesMedico");
        const seccionAgendaEl = document.getElementById("seccionAgenda");
        const seccionDatosConsultaEl = document.getElementById("seccionDatosConsulta");
        const tablaConsultasEl = document.getElementById('tablaConsultas');
        const seccionCargarResultadosEl = document.getElementById("seccionCargarResultados");

        // --- Referencias a los botones del sidebar ---
        const btnDatosPersonales = document.getElementById("btnDatosPersonales");
        const btnAgenda = document.getElementById("btnAgenda");
        const btnResultados = document.getElementById("btnResultados");
        const btnDatosConsulta = document.getElementById("btnDatosConsulta");

        // --- Referencias al modal de subida de im√°genes ---
        const modalSubida = document.getElementById('modalSubirImagenes');
        const formSubida = document.getElementById('formSubirImagenes');
        const inputConsultaId = document.getElementById('idConsultaParaSubida');
        const modalSubidaTitulo = document.getElementById('modalSubidaTitulo');
        const inputArchivos = document.getElementById('inputArchivos');
        const previewsContainer = document.getElementById('previewsContainer');
        const btnSubirArchivos = document.querySelector('#formSubirImagenes button[type="submit"]');

        // =======================================================
        // == PARTE 2: ASIGNACI√ìN DE TODOS LOS EVENT LISTENERS ==
        // =======================================================

        document.getElementById("cerrarSesion").addEventListener("click", () => {
            sessionStorage.clear();
            localStorage.clear();
            window.location.href = "/Clinica.html";
        });

        btnDatosPersonales.addEventListener('click', (e) => { e.preventDefault(); cargarDatosPersonalesMedico(); });
        btnAgenda.addEventListener('click', (e) => { e.preventDefault(); inicializarAgenda(); });
        btnDatosConsulta.addEventListener("click", (e) => { e.preventDefault(); mostrarSeccion("seccionDatosConsulta"); });

        tablaConsultasEl.addEventListener('click', (e) => {
            if (e.target.classList.contains('btn-subir-img')) {
                const idConsulta = e.target.dataset.idConsulta;
                const nombrePaciente = e.target.dataset.paciente;
                inputConsultaId.value = idConsulta;
                modalSubidaTitulo.textContent = `Subir Im√°genes para: ${nombrePaciente} (Consulta #${idConsulta})`;
                modalSubida.classList.remove('hidden');
                abrirModalGestionImagenes(idConsulta, nombrePaciente);
            }
        });

        document.getElementById('closeModalSubida').addEventListener('click', () => {
            modalSubida.classList.add('hidden');
            formSubida.reset();
            previewsContainer.innerHTML = '';
            btnSubirArchivos.disabled = true;
            document.getElementById('mensajeSubida').innerHTML = '';
        });

        formSubida.addEventListener('submit', async (e) => {
            e.preventDefault();
            const idConsulta = inputConsultaId.value;
            const mensajeSubidaEl = document.getElementById('mensajeSubida');

            // CREAMOS EL FORMDATA A PARTIR DE NUESTRO ARRAY, NO DEL INPUT
            const formData = new FormData();
            formData.append('descripcion', document.getElementById('inputDescripcion').value);

            archivosParaSubir.forEach(file => {
                formData.append('imagenesConsulta', file); // 'imagenesConsulta' debe coincidir con el backend
            });

            mensajeSubidaEl.innerHTML = '<div class="mensaje-alerta">Subiendo im√°genes...</div>';

            try {
                const res = await fetch(`/api/consultas/${idConsulta}/upload`, {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();

                if (data.ok) {
                    mensajeSubidaEl.innerHTML = '<div class="mensaje-alerta exito">‚úÖ Im√°genes subidas con √©xito.</div>';
                    archivosParaSubir = []; // Limpiamos nuestro carrito
                    renderizarVistasPrevias(); // Limpiamos las vistas previas
                    setTimeout(() => {
                        modalSubida.classList.add('hidden');
                        formSubida.reset();
                    }, 2000);
                } else {
                    mensajeSubidaEl.innerHTML = `<div class="mensaje-alerta error">‚ùå ${data.mensaje}</div>`;
                }
            } catch (err) {
                mensajeSubidaEl.innerHTML = '<div class="mensaje-alerta error">üîå Error de conexi√≥n.</div>';
            }
        });

        inputArchivos.addEventListener('change', handleFileSelect);

        document.getElementById('formAgregarConsulta').addEventListener('submit', async (e) => { /* ... tu l√≥gica de submit de consulta ... */ });
        document.querySelector('#filtroEstado').addEventListener('change', aplicarFiltros);
        document.querySelector('#busquedaGeneral').addEventListener('input', aplicarFiltros);

        async function abrirModalGestionImagenes(idConsulta, nombrePaciente) {
            const modal = document.getElementById('modalSubirImagenes');
            const galeria = document.getElementById('galeriaImagenesExistentes');
            const inputConsultaId = document.getElementById('idConsultaParaSubida');
            const modalTitulo = document.getElementById('modalSubidaTitulo');

            // 1. Preparamos el modal
            galeria.innerHTML = '<p>Cargando im√°genes existentes...</p>';
            inputConsultaId.value = idConsulta;
            modalTitulo.textContent = `Gestionar Im√°genes de: ${nombrePaciente} (#${idConsulta})`;
            modal.classList.remove('hidden');

            // 2. Hacemos fetch a la nueva ruta del backend para obtener las im√°genes
            try {
                const res = await fetch(`/api/consultas/${idConsulta}/imagenes`, { credentials: 'include' });
                const data = await res.json();

                galeria.innerHTML = ''; // Limpiamos el mensaje de "cargando"
                if (data.ok && data.imagenes.length > 0) {
                    data.imagenes.forEach(img => {
                        const item = document.createElement('div');
                        item.className = 'imagen-item';
                        item.innerHTML = `
                    <img src="${img.url}" alt="Imagen de consulta">
                    <button class="btn-eliminar-img" data-id-imagen="${img.idImagen}" title="Eliminar Imagen">&times;</button>
                `;
                        galeria.appendChild(item);
                    });
                } else {
                    galeria.innerHTML = '<p>No hay im√°genes para esta consulta.</p>';
                }
            } catch (error) {
                console.error("Error al cargar im√°genes:", error);
                galeria.innerHTML = '<p style="color:red;">Error al cargar las im√°genes.</p>';
            }
        }

        // A√±ade un event listener para manejar la eliminaci√≥n de im√°genes
        document.getElementById('galeriaImagenesExistentes').addEventListener('click', async (e) => {
            if (e.target.classList.contains('btn-eliminar-img')) {
                const idImagen = e.target.dataset.idImagen;
                const imagenItem = e.target.closest('.imagen-item');

                if (confirm('¬øEst√°s seguro de que deseas eliminar esta imagen de forma permanente?')) {
                    try {
                        const res = await fetch(`/api/imagenes/${idImagen}`, {
                            method: 'DELETE',
                            credentials: 'include'
                        });
                        const data = await res.json();

                        if (data.ok) {
                            imagenItem.remove(); // Elimina la imagen del DOM para feedback instant√°neo
                            alert('Imagen eliminada.');
                        } else {
                            alert(`Error: ${data.mensaje}`);
                        }
                    } catch (error) {
                        alert('Error de conexi√≥n al intentar eliminar la imagen.');
                    }
                }
            }
        });


        const hoy = new Date().toISOString().split('T')[0];
        document.getElementById('fecha').setAttribute('min', hoy);

        // =======================================================
        // == PARTE 3: DEFINICI√ìN DE TODAS LAS FUNCIONES ==
        // =======================================================

        // --- FUNCI√ìN PARA MOSTRAR SECCIONES (SIN CAMBIOS) ---
        function mostrarSeccion(seccionIdAMostrar) {
            // Lista actualizada de TODAS las secciones de contenido posibles.
            const todasLasSecciones = [
                inicioPanelMedicoEl,
                seccionDatosPersonalesMedicoEl,
                seccionAgendaEl,
                seccionDatosConsultaEl, // <--- La nueva secci√≥n ya est√° aqu√≠
                seccionCargarResultadosEl
            ];

            // Ocultamos todas las secciones
            todasLasSecciones.forEach(seccion => {
                if (seccion) { // Verificamos que el elemento exista
                    seccion.classList.add('hidden');
                }
            });

            // Mostramos solo la que queremos
            const seccionAMostrar = document.getElementById(seccionIdAMostrar);
            if (seccionAMostrar) {
                seccionAMostrar.classList.remove('hidden');
            }
        }
        // CORRECCI√ìN 2: Se a√±ade `{ credentials: 'include' }` a CADA `fetch` para enviar la cookie de sesi√≥n.

        async function cargarNombreUsuarioYMostrarInicio() {
            try {
                const resNombre = await fetch('/nombre-usuario', { credentials: 'include' });
                if (resNombre.status === 401) {
                    window.location.href = '/Clinica.html';
                    return;
                }
                const dataNombre = await resNombre.json();
                if (dataNombre.ok) {
                    // Llenamos el saludo de la barra lateral
                    nombreUsuarioEl.textContent = `üë®‚Äç‚öïÔ∏è ${dataNombre.nombreUsuario}`;

                    // --- NUEVO: Llenamos los campos del formulario ---
                    document.getElementById('nombreMedicoLogueado').value = dataNombre.nombreUsuario;
                    document.getElementById('idMedicoLogueado').value = dataNombre.idMedico;
                    // -------------------------------------------------

                    mostrarSeccion('inicioPanelMedico');
                } else {
                    nombreUsuarioEl.textContent = "Usuario no encontrado";
                }
            } catch (err) {
                console.error("Error al verificar sesi√≥n o cargar nombre:", err);
                nombreUsuarioEl.textContent = "Error de conexi√≥n";
            }
        }



        async function cargarDatosPersonalesMedico() {
            mostrarSeccion("seccionDatosPersonalesMedico");
            const targetEl = document.getElementById("seccionDatosPersonalesMedico");
            targetEl.innerHTML = "<h2>Cargando Datos Personales...</h2>"; // Mensaje de carga
            try {
                const res = await fetch('/obtener-medico', { credentials: 'include' });
                if (res.status === 401) {
                    targetEl.innerHTML = "<p>No autorizado. Inicie sesi√≥n como m√©dico.</p>";
                    return;
                }
                const data = await res.json();
                if (data.ok) {
                    const info = data.datos;
                    // NUEVA ESTRUCTURA HTML CON CLASES PARA EL DISE√ëO
                    targetEl.innerHTML = `
                        <h2>Datos Personales</h2>
                        <div class="datos-personales-grid">
                            <div class="dato-item">
                                <strong>Nombre Completo</strong>
                                <span>${info.nombreCompleto || 'No disponible'}</span>
                            </div>
                            <div class="dato-item">
                                <strong>C√©dula Profesional</strong>
                                <span>${info.cedulaProfesional || 'No disponible'}</span>
                            </div>
                            <div class="dato-item">
                                <strong>Tel√©fono</strong>
                                <span>${info.telefono || 'No disponible'}</span>
                            </div>
                            <div class="dato-item">
                                <strong>Especializaci√≥n</strong>
                                <span>${info.nombreEspecializacion || 'No disponible'}</span>
                            </div>
                             <div class="dato-item">
                                <strong>Nombre de Usuario</strong>
                                <span>${info.nombreUsuario || 'No disponible'}</span>
                            </div>
                        </div>`;
                } else {
                    targetEl.innerHTML = `<p>No se encontraron datos: ${data.mensaje || 'Error'}</p>`;
                }
            } catch (err) {
                console.error("Error al obtener datos personales:", err);
                targetEl.innerHTML = "<p>Error al obtener los datos personales.</p>";
            }
        }
        // --- C√ìDIGO DE MANEJO DE CONSULTAS (CON CORRECCIONES) ---


        async function cargarConsultas() {
            try {
                const res = await fetch('/consultas', { credentials: 'include' });
                const data = await res.json();
                if (data.ok) {
                    consultasGlobales = data.consultas;
                    aplicarFiltros(); // Llama a la funci√≥n que renderiza la tabla
                } else {
                    alert('Error al cargar consultas: ' + (data.mensaje || 'Respuesta no v√°lida'));
                }
            } catch (err) {
                alert('Error de conexi√≥n al cargar consultas.');
                console.error(err);
            }
        }

        function aplicarFiltros() {
            const filtroEstado = document.querySelector('#filtroEstado').value.toLowerCase();
            // Usamos el nuevo ID del campo de b√∫squeda
            const busquedaGeneral = document.querySelector('#busquedaGeneral').value.toLowerCase();

            filteredConsultas = consultasGlobales.filter(c => {
                const estadoMatch = filtroEstado === '' || (c.estado?.toLowerCase() || '') === filtroEstado;

                // La nueva l√≥gica de b√∫squeda general
                const busquedaMatch = busquedaGeneral === '' ||
                    c.nombrePaciente?.toLowerCase().includes(busquedaGeneral) ||
                    c.nombreMedico?.toLowerCase().includes(busquedaGeneral);

                return estadoMatch && busquedaMatch;
            });

            currentPage = 1; // Siempre regresa a la primera p√°gina despu√©s de un filtro
            renderTablePage(); // Llama a la nueva funci√≥n para dibujar la tabla
        }

        /**
 * Dibuja la p√°gina actual de la tabla.
 */
        function renderTablePage() {
            const tbody = document.querySelector('#tablaConsultas tbody');
            tbody.innerHTML = '';

            const startIndex = (currentPage - 1) * rowsPerPage;
            const endIndex = startIndex + rowsPerPage;
            const paginatedItems = filteredConsultas.slice(startIndex, endIndex);

            if (paginatedItems.length === 0) {
                tbody.innerHTML = `<tr><td colspan="12" style="text-align: center; padding: 20px;">No se encontraron consultas.</td></tr>`;
            } else {
                paginatedItems.forEach(c => {
                    const fila = document.createElement('tr');
                    const fechaFormateada = c.fecha ? c.fecha.split('T')[0] : 'Sin fecha';
                    let estadoClass = `estado-${c.estado?.toLowerCase() || 'default'}`;

                    // El contenido de la fila sigue siendo el mismo
                    fila.innerHTML = `
                <td>${c.idConsulta || ''}</td>
                <td>${fechaFormateada}</td>
                <td>${c.hora || ''}</td>
                <td><span class="estado-badge ${estadoClass}">${c.estado || ''}</span></td>
                <td>${c.nombrePaciente || ''}</td>
                <td>${c.cedula || 'N/A'}</td>
                <td>${c.nombreMedico || ''}</td>
                <td>${c.nombreSala || ''}</td>
                <td>${c.nombreRecepcionista || ''}</td>
                <td>${c.observaciones || ''}</td>
                <td>${c.nombreServicio || ''}</td>
                <td>
                    <button class="btn-subir-img" data-id-consulta="${c.idConsulta}" data-paciente="${c.nombrePaciente}">
                        Subir Im√°genes
                    </button>
                </td>`;
                    tbody.appendChild(fila);
                });
            }
            updatePaginationControls(); // Actualiza los botones "Anterior/Siguiente"
        }

        /**
         * Actualiza los controles de paginaci√≥n (botones y texto).
         */
        function updatePaginationControls() {
            const pageInfo = document.getElementById('pageInfo');
            const prevPageBtn = document.getElementById('prevPage');
            const nextPageBtn = document.getElementById('nextPage');

            const totalPages = Math.ceil(filteredConsultas.length / rowsPerPage);

            pageInfo.textContent = `P√°gina ${currentPage} de ${totalPages > 0 ? totalPages : 1}`;
            prevPageBtn.disabled = currentPage === 1;
            nextPageBtn.disabled = currentPage === totalPages || totalPages === 0;
        }

        // Listeners para los nuevos controles de paginaci√≥n
        document.getElementById('prevPage').addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderTablePage();
            }
        });

        document.getElementById('nextPage').addEventListener('click', () => {
            const totalPages = Math.ceil(filteredConsultas.length / rowsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                renderTablePage();
            }
        });

        document.getElementById('rowsPerPage').addEventListener('change', (e) => {
            rowsPerPage = parseInt(e.target.value, 10);
            currentPage = 1; // Resetea a la primera p√°gina
            renderTablePage();
        });

        document.querySelector('#filtroEstado').addEventListener('change', aplicarFiltros);
        document.querySelector('#busquedaGeneral').addEventListener('input', aplicarFiltros);

        // --- C√ìDIGO DE FORMULARIO (CON CORRECCIONES) ---

        async function cargarCatalogos() {
            try {
                const [pacientesRes, medicosRes, salasRes, recepcionistasRes, serviciosRes] = await Promise.all([
                    fetch('/catalogos/pacientes', { credentials: 'include' }),
                    fetch('/catalogos/medicos', { credentials: 'include' }),
                    fetch('/catalogos/salas', { credentials: 'include' }),
                    fetch('/catalogos/recepcionistas', { credentials: 'include' }),
                    fetch('/catalogos/servicios', { credentials: 'include' })
                ]);

                // CORRECCI√ìN 4: Se ha eliminado el '1' suelto que causaba un error de sintaxis.

                llenarSelect(document.getElementById('selectPaciente'), await pacientesRes.json(), 'idPaciente', 'nombreCompleto');
                llenarSelect(document.getElementById('selectMedico'), await medicosRes.json(), 'idMedico', 'nombreCompleto');
                llenarSelect(document.getElementById('selectSala'), await salasRes.json(), 'idSala', 'nombre');
                llenarSelect(document.getElementById('selectRecepcionista'), await recepcionistasRes.json(), 'idRecepcionista', 'nombreCompleto');
                llenarSelect(document.getElementById('selectServicio'), await serviciosRes.json(), 'idServicio', 'nombreServicio');

                // Destruimos instancias anteriores si es que existen (para evitar errores)
                if (choicesPaciente) choicesPaciente.destroy();


                // Inicializamos el buscador para Pacientes
                choicesPaciente = new Choices(document.getElementById('selectPaciente'), {
                    searchPlaceholderValue: "Escribe para buscar un paciente...",
                    removeItemButton: true, // Permite quitar la selecci√≥n con una 'x'
                    itemSelectText: 'Seleccionar',
                });


            } catch (error) {
                console.error("Error al cargar los cat√°logos:", error);
            }
        }

        function llenarSelect(selectEl, datos, valueField, textField) {
            if (!selectEl) return;
            selectEl.innerHTML = '<option value="">Seleccione‚Ä¶</option>';
            if (Array.isArray(datos)) {
                datos.forEach(item => {
                    const opt = document.createElement('option');
                    opt.value = item[valueField];
                    opt.textContent = item[textField];
                    selectEl.appendChild(opt);
                });
            }
        }

        document.getElementById('formAgregarConsulta').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;

            const datos = {
                fecha: form.fecha.value,
                hora: form.hora.value,
                estado: form.estado.value,
                observaciones: form.observaciones.value,
                idPaciente: parseInt(form.idPaciente.value),
                idMedico: parseInt(form.idMedico.value),
                idSala: parseInt(form.idSala.value),
                idRecepcionista: parseInt(form.idRecepcionista.value),
                idServicio: parseInt(form.idServicio.value)
            };

            const mensajeDiv = document.getElementById('mensajeConsulta');

            const fechaSeleccionada = new Date(form.fecha.value + 'T' + form.hora.value);
            if (fechaSeleccionada < new Date()) {
                mensajeDiv.className = 'mensaje-formulario error'; // Usa la clase de error
                mensajeDiv.textContent = '‚ùå No se puede agendar una consulta en una fecha u hora pasada.';

                // Limpiamos el mensaje despu√©s de 4 segundos
                setTimeout(() => {
                    mensajeDiv.textContent = '';
                    mensajeDiv.className = 'mensaje-formulario';
                }, 4000);
                return; // Detenemos el env√≠o
            }

            
            // Funci√≥n para limpiar el mensaje despu√©s de un tiempo
            const limpiarMensaje = () => {
                setTimeout(() => {
                    mensajeDiv.textContent = '';
                    // Quita las clases 'exito' y 'error' para ocultar el fondo y los bordes
                    mensajeDiv.className = 'mensaje-formulario';
                }, 4000); // El mensaje desaparecer√° despu√©s de 4 segundos
            };

            try {
                const res = await fetch('/agregar-consulta', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(datos),
                    credentials: 'include'
                });
                const data = await res.json();

                // Limpiamos clases de un uso anterior
                mensajeDiv.classList.remove('exito', 'error');

                if (data.ok) {
                    mensajeDiv.classList.add('exito'); // ‚úÖ A√±ade la clase de √©xito
                    mensajeDiv.textContent = data.mensaje;
                    form.reset();
                    cargarConsultas();
                } else {
                    mensajeDiv.classList.add('error'); // ‚ùå A√±ade la clase de error
                    mensajeDiv.textContent = data.mensaje;
                }

                limpiarMensaje(); // Llama a la funci√≥n para que el mensaje desaparezca

            } catch (err) {
                mensajeDiv.classList.remove('exito', 'error');
                mensajeDiv.classList.add('error');
                mensajeDiv.textContent = 'Error de conexi√≥n. Int√©ntelo de nuevo.';
                limpiarMensaje(); // Tambi√©n hacemos que desaparezca en caso de error
            }
        });

        function renderizarVistasPrevias() {
            previewsContainer.innerHTML = ''; // Limpiar siempre antes de volver a dibujar

            archivosParaSubir.forEach((file, index) => {
                const previewItem = document.createElement('div');
                previewItem.classList.add('preview-item');

                const previewImage = document.createElement('img');
                const reader = new FileReader();
                reader.onload = () => { previewImage.src = reader.result; };
                reader.readAsDataURL(file);
                previewItem.appendChild(previewImage);

                // Creamos el bot√≥n de eliminar
                const removeBtn = document.createElement('button');
                removeBtn.type = 'button'; // MUY IMPORTANTE: para que no env√≠e el formulario
                removeBtn.classList.add('preview-remove-btn');
                removeBtn.innerHTML = '&times;';
                removeBtn.title = 'Eliminar imagen';
                removeBtn.dataset.index = index; // Guardamos el √≠ndice para saber cu√°l borrar
                previewItem.appendChild(removeBtn);

                previewsContainer.appendChild(previewItem);
            });

            btnSubirArchivos.disabled = archivosParaSubir.length === 0;
        }

        function inicializarAgenda() {
            mostrarSeccion('seccionAgenda');

            const calendarEl = document.getElementById('calendario-agenda');
            const panelDetalles = document.getElementById('panelDetallesCita');
            const btnCerrarPanel = document.getElementById('cerrarPanelDetalles');

            // L√≥gica para cerrar el panel
            btnCerrarPanel.addEventListener('click', () => {
                panelDetalles.classList.remove('visible');
            });

            if (calendarEl.querySelector('.fc')) {
                const calendar = FullCalendar.Calendar.getInstance(calendarEl);
                if (calendar) { calendar.refetchEvents(); }
                return;
            }

            const calendar = new FullCalendar.Calendar(calendarEl, {
                locale: 'es',
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                events: function (fetchInfo, successCallback, failureCallback) {
                    fetch('/consultas/agenda', { credentials: 'include' })
                        .then(response => {
                            if (!response.ok) throw new Error(`Error ${response.status}`);
                            return response.json();
                        })
                        .then(data => successCallback(data))
                        .catch(error => failureCallback(error));
                },
                dateClick: function (info) {
                    mostrarSeccion('seccionDatosConsulta');
                    document.getElementById('fecha').value = info.dateStr;
                    document.getElementById('hora').focus();
                },

                // ================================================================
                // ==        MODIFICACI√ìN DE eventClick PARA MOSTRAR EL PANEL      ==
                // ================================================================
                eventClick: function (info) {
                    const evento = info.event;

                    // Separamos el t√≠tulo para obtener el servicio y el paciente
                    const [servicio, paciente] = evento.title.split(' - ');

                    // Llenamos el panel con la informaci√≥n del evento
                    document.getElementById('detalleServicio').textContent = servicio || 'No disponible';
                    document.getElementById('detallePaciente').textContent = paciente || 'No disponible';
                    document.getElementById('detalleFechaHora').textContent = evento.start.toLocaleString('es-NI', {
                        dateStyle: 'long',
                        timeStyle: 'short'
                    });

                    // Mostramos el panel
                    panelDetalles.classList.add('visible');
                }
            });

            calendar.render();
        }

        // --- FUNCI√ìN QUE SE ACTIVA AL SELECCIONAR ARCHIVOS ---
        function handleFileSelect(event) {
            const nuevosArchivos = event.target.files;
            for (const file of nuevosArchivos) {
                if (file.type.startsWith('image/') && !archivosParaSubir.some(f => f.name === file.name)) {
                    archivosParaSubir.push(file);
                }
            }
            event.target.value = ''; // Resetea el input para poder seleccionar los mismos archivos
            renderizarVistasPrevias(); // Redibuja las vistas previas con los nuevos archivos
        }


        // --- EVENT LISTENERS DEL MODAL ---

        // 1. Listener para el input de archivos
        inputArchivos.addEventListener('change', handleFileSelect);


        // 2. Listener para ELIMINAR im√°genes (LA PIEZA CLAVE QUE PROBABLEMENTE FALTABA)
        previewsContainer.addEventListener('click', (e) => {
            // Si el elemento clickeado es un bot√≥n de eliminar
            if (e.target.classList.contains('preview-remove-btn')) {
                // Obtenemos el √≠ndice del archivo a eliminar
                const indexAEliminar = parseInt(e.target.dataset.index, 10);

                // Eliminamos el archivo de nuestro array "carrito"
                archivosParaSubir.splice(indexAEliminar, 1);

                // Volvemos a dibujar las vistas previas actualizadas
                renderizarVistasPrevias();
            }
        });

        // ==============================================================
        // == PARTE 4: C√ìDIGO QUE SE EJECUTA AL INICIAR LA P√ÅGINA ==
        // ==============================================================
        cargarNombreUsuarioYMostrarInicio();
        cargarCatalogos();
        cargarConsultas();

    }); 
</script>

</html>