<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Restablecer Contraseña</title>
    <link rel="stylesheet" href="styleclinica.css">
</head>

<body>
    <div id="modalReset" class="modal" style="display: flex;">
        <div class="modal-content animate-in">
            <form id="resetForm" class="login-form">
                <h2>Crea tu Nueva Contraseña</h2>

                <div class="password-container">
                    <input type="password" name="nuevaContrasena" id="nuevaContrasena" placeholder="Nueva Contraseña"
                        required />
                    <span class="toggle-password" onclick="togglePassword('nuevaContrasena')">👁️</span>
                </div>

                <div class="password-container">
                    <input type="password" name="confirmarContrasena" id="confirmarContrasena"
                        placeholder="Confirmar Nueva Contraseña" required />
                    <span class="toggle-password" onclick="togglePassword('confirmarContrasena')">👁️</span>
                </div>

                <button type="submit">Guardar Contraseña</button>
                <p id="mensajeReset" class="error-msg"></p>
            </form>
        </div>
    </div>

    <script>
        // Función para mostrar/ocultar CUALQUIER campo de contraseña
        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            if (input) {
                input.type = input.type === "password" ? "text" : "password";
            }
        }

        document.getElementById('resetForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            const form = e.target;
            const nuevaContrasena = form.nuevaContrasena.value;
            const confirmarContrasena = form.confirmarContrasena.value;
            const mensajeEl = document.getElementById('mensajeReset');

            // Ocultamos cualquier mensaje de error previo
            mensajeEl.classList.remove('visible');

            const passwordSegura = /^(?=.*[a-zA-Z])(?=.*\d).{5,}$/;

            if (nuevaContrasena !== confirmarContrasena) {
                mensajeEl.textContent = 'Las contraseñas no coinciden.';
                // Añadimos la clase 'visible' para mostrarlo con animación
                mensajeEl.classList.add('visible');
                return;
            }

            if (!passwordSegura.test(nuevaContrasena)) {
                mensajeEl.textContent = "La contraseña debe tener al menos 5 caracteres y contener letras y números.";
                // Añadimos la clase 'visible' para mostrarlo con animación
                mensajeEl.classList.add('visible');
                return;
            }

            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');

            if (!token) {
                mensajeEl.textContent = 'Token no encontrado. El enlace puede estar roto.';
                mensajeEl.classList.add('visible');
                return;
            }

            try {
                const res = await fetch('/reset-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token, nuevaContrasena })
                });
                const data = await res.json();

                if (res.ok) {
                    // Para los mensajes de éxito, podemos cambiar el estilo si queremos,
                    // o simplemente mostrar un mensaje de texto.
                    mensajeEl.textContent = data.mensaje;
                    mensajeEl.style.color = '#28a745'; // Color verde para éxito
                    mensajeEl.classList.add('visible');

                    form.reset();
                    form.nuevaContrasena.disabled = true;
                    form.confirmarContrasena.disabled = true;
                    form.querySelector('button').disabled = true;

                    setTimeout(() => {
                        window.location.href = './Clinica.html';
                    }, 3000);
                } else {
                    mensajeEl.textContent = data.mensaje;
                    mensajeEl.style.color = ''; // Revertimos a color de error por defecto
                    mensajeEl.classList.add('visible');
                }
            } catch (err) {
                mensajeEl.textContent = 'Error de conexión.';
                mensajeEl.style.color = ''; // Revertimos a color de error por defecto
                mensajeEl.classList.add('visible');
            }
        });
    </script>
</body>

</html>